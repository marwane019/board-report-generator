# =============================================================================
# .github/workflows/azure-deploy.yml
#
# CI/CD pipeline: Test -> Build Docker -> Push to ACR -> Deploy to App Service
#
# Triggers:
#   push to main/master  -> test + build + deploy
#   pull_request         -> test only
#   workflow_dispatch    -> manual full run (for triggering from GitHub UI)
#
# Required GitHub Secrets:
#   AZURE_CREDENTIALS    Service principal JSON (az ad sp create-for-rbac --sdk-auth)
#   ACR_LOGIN_SERVER     e.g. boardreportacr.azurecr.io
#   ACR_USERNAME         ACR admin username
#   ACR_PASSWORD         ACR admin password
#
# Optional Secrets (pipeline runs in dry-run mode when absent):
#   SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASSWORD, SLACK_WEBHOOK_URL
# =============================================================================

name: CI-CD Board Report Generator

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AZURE_WEBAPP_NAME: board-report-generator-app
  RESOURCE_GROUP: rg-board-report
  IMAGE_NAME: board-report-generator
  PYTHON_VERSION: "3.11"

# =============================================================================
# Job 1: Run test suite (every push and PR)
# =============================================================================
jobs:
  test:
    name: Test suite (Python 3.11)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install --no-cache-dir -r requirements.txt

      - name: Run pytest with coverage
        env:
          MPLBACKEND: Agg
          PYTHONUNBUFFERED: "1"
        run: |
          pytest tests/ \
            --verbose \
            --tb=short \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=80

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

# =============================================================================
# Job 2: Build + Push + Deploy  (push to main/master or manual dispatch only)
# =============================================================================
  build-and-deploy:
    name: Build and Deploy to Azure
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Log in to Azure using the service principal JSON secret
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Authenticate Docker to ACR so we can push
      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # Build the image and tag with both :latest and the immutable git SHA
      - name: Build Docker image
        run: |
          docker build \
            --tag "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest" \
            --tag "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.ref.name=${{ github.ref }}" \
            .

      # Push both tags to ACR
      - name: Push image to ACR
        run: |
          docker push "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest"
          docker push "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      # Set App Service environment variables via az CLI
      # Using az CLI directly avoids YAML nesting issues with the action's JSON input
      - name: Configure App Service environment variables
        run: |
          az webapp config appsettings set \
            --name "${{ env.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --settings \
              WEBSITES_PORT=8000 \
              PYTHONUNBUFFERED=1 \
              MPLBACKEND=Agg \
              LOG_LEVEL=INFO \
              SMTP_HOST="${{ secrets.SMTP_HOST }}" \
              SMTP_PORT="${{ secrets.SMTP_PORT || '587' }}" \
              SMTP_USER="${{ secrets.SMTP_USER }}" \
              SMTP_PASSWORD="${{ secrets.SMTP_PASSWORD }}" \
              SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}" \
            --output none

      # Deploy the SHA-tagged image; SHA tag enables precise rollback
      - name: Deploy container to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      # Confirm the app is running after deployment
      - name: Verify deployment
        run: |
          az webapp show \
            --name "${{ env.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "{state:state, hostName:defaultHostName, lastModified:lastModifiedTimeUtc}" \
            --output table
          echo "Deployed: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      - name: Log out of Azure
        if: always()
        run: az logout
