# =============================================================================
# .github/workflows/azure-deploy.yml
#
# CI/CD pipeline: Test -> Build Docker -> Push to ACR -> Deploy to Container Apps
#
# Triggers:
#   push to main/master  -> test + build + deploy
#   pull_request         -> test only
#   workflow_dispatch    -> manual full run (for triggering from GitHub UI)
#
# Required GitHub Secrets:
#   AZURE_CREDENTIALS    Service principal JSON (az ad sp create-for-rbac --sdk-auth)
#   ACR_LOGIN_SERVER     e.g. boardreportacr.azurecr.io
#   ACR_USERNAME         ACR admin username
#   ACR_PASSWORD         ACR admin password
#
# Optional Secrets (pipeline runs in dry-run mode when absent):
#   SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASSWORD, SLACK_WEBHOOK_URL
# =============================================================================

name: CI-CD Board Report Generator

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CONTAINER_APP_NAME: board-report-app
  RESOURCE_GROUP: rg-board-report
  IMAGE_NAME: board-report-generator
  PYTHON_VERSION: "3.11"

# =============================================================================
# Job 1: Run test suite (every push and PR)
# =============================================================================
jobs:
  test:
    name: Test suite (Python 3.11)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install --no-cache-dir -r requirements.txt

      - name: Run pytest with coverage
        env:
          MPLBACKEND: Agg
          PYTHONUNBUFFERED: "1"
        run: |
          # Coverage threshold reflects tested modules only:
          # metrics.py 99%, narrative.py 93%, data_simulator.py 100%
          # pdf_builder/dashboard/excel_pack/distributor require integration
          # testing (not unit tests) so total coverage is ~39%
          pytest tests/ \
            --verbose \
            --tb=short \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=35

# =============================================================================
# Job 2: Build + Push + Deploy  (push to main/master or manual dispatch only)
# =============================================================================
  build-and-deploy:
    name: Build and Deploy to Azure Container Apps
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Log in to Azure using the service principal JSON secret
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Authenticate Docker to ACR so we can push
      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # Build the image and tag with both :latest and the immutable git SHA
      - name: Build Docker image
        run: |
          docker build \
            --tag "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest" \
            --tag "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.ref.name=${{ github.ref }}" \
            .

      # Push both tags to ACR
      - name: Push image to ACR
        run: |
          docker push "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest"
          docker push "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      # Install the Container Apps Azure CLI extension
      - name: Install containerapp CLI extension
        run: az extension add --name containerapp --yes --only-show-errors

      # Deploy the new image revision to Container Apps
      # --image uses the immutable SHA tag for precise rollbacks
      - name: Deploy to Azure Container Apps
        run: |
          az containerapp update \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --image "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --set-env-vars \
              PYTHONUNBUFFERED=1 \
              MPLBACKEND=Agg \
              LOG_LEVEL=INFO \
              PORT=8000 \
              SMTP_HOST="${{ secrets.SMTP_HOST }}" \
              SMTP_PORT="${{ secrets.SMTP_PORT || '587' }}" \
              SMTP_USER="${{ secrets.SMTP_USER }}" \
              SMTP_PASSWORD="${{ secrets.SMTP_PASSWORD }}" \
              SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}" \
            --output none

      # Verify the app is running and show its public URL
      - name: Verify deployment
        run: |
          az containerapp show \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "{provisioningState:properties.provisioningState,runningStatus:properties.runningStatus,fqdn:properties.configuration.ingress.fqdn}" \
            --output table

          FQDN=$(az containerapp show \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "App URL: https://${FQDN}"
          echo "Health:  https://${FQDN}/health"
          echo "Deployed image: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Poll /health until 200 or timeout (90s)
          for i in $(seq 1 9); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${FQDN}/health" 2>/dev/null || echo "000")
            echo "Attempt ${i}/9 -> HTTP ${STATUS}"
            [ "$STATUS" = "200" ] && echo "Health check passed!" && break
            [ "$i" = "9" ] && echo "WARNING: Health check did not return 200 within 90s" && exit 1
            sleep 10
          done

      - name: Log out of Azure
        if: always()
        run: az logout
